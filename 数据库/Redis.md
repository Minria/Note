# 缓存简介

缓存定义

> 缓存是一个高速数据交换的缓存器，使用它可以快速的访问和操作数据。

缓存的优点

> 1、缓存key-value，存储结构简单，查询效率快。
>
> 2、缓存时存储在内存中，而一般数据库存储在硬盘中。
>
> 3、缓存更容易做分布式部署。

# 缓存分类

本地缓存（单机缓存）

程序只有一份时，访问一个服务器。

**本地缓存的特征是只适用与当前操作系统。**

分布式缓存

可以适用多态服务器。

# 缓存应用

本地缓存常见使用：Spring Cache 、MyBatis等

分布式缓存常见使用：Redis和Memcached

----Spring Cache为例子

Redis和Memcached

储存方式不同：前者部分数据放在硬盘上，后者全部在内存中

数据支持类型：前者数据复杂，后者数据简单

存储值大小不同：前者512mb，后者1mb

# Redis使用

key-value型，key都是字符串型

1、String-字符串

比较常用

```redis
set key value
get key
setex key seconds value
setnx key value 
```



2、Hash-字典

适合存储对象

```redis
HSET key field value 将哈希表key中的字段field的值设为value
HGET key field 获取存储在哈希表中指定字段的值
HDEL key field 删除存储在哈希表中的指定字段
HKEYS key 获取哈希表中所有字段
HVALS key 获取哈希表中所有值
HGETALL key 获取在哈希表中指定key的所有字段和值
```



3、List-列表

按照插入顺序排序，可以重复；可以实现任务队列

```redis
LPUSH key value1 [value2] 将一个或多个值插入到列表头部
LRANGE key start stop 获取列表指定范围内的元素
RPOP key 移除并获取列表最后一个元素
LLEN key 获取列表长度
BRPOP key1 [key2 timeout 移出并获取列表的最后一个元素，如果列表没有元素会阻塞列表直到等待超时
或发现可弹出元素为止
```



4、Set-集合类型

无序的、不允许有重复元素的

```redis
SADD key member1 [member2] 向集合添加一个或多个成员
SMEMBERS key 返回集合中的所有成员
SCARD key 获取集合的成员数
SINTER key1 [key2] 返回给定所有集合的交集
SUNION key1 [key2] 返回所有给定集合的并集
SDIFF key1 [key2) 返回给定所有集合的差集
SREM key member1 [member2] 移除集合中一个或多个成员
```



5、ZSet-有序集合类型

6、通用命令

```redis
KEYS pattern 查找所有符合给定模式(pattern)的key
EXISTS key 检查给定key是否存在
TYPE key 返回key所储存的值的类型
TTL key 返回给定key的剩余生存时间(TTL,time to live),以秒为单位
DEL key 该命令用于在key存在是副除key
```



# 持久化

就是将数据从内存保存到磁盘的过程中。目的就是方式数据丢失

1、快照方式（RDB ）将某个时刻内存数据以二进制的方式写入磁盘

2、文件追加方式（AOF） 记录所有的操作命令，并以文本的形式追加到文件中

3、混合持久方式，先把当前书库以RDB的形式写入文件的开头，再将后续的操作的命令以AOF的格式写入文件。既保证启动速度，也防止数据丢失。

`config set aof-use-rdb-preamble yes`

`config ser appendonly yes`

RDB的优点

内容为二进制数据，占用的内存小，适合备份文件

RDB对灾难恢复非常有用，它是一个紧凑的文件，可以更快的传输到远程服务器进行Redis恢复

RDB可以更大程度的提高 Redis I的运行速度，因为每次持久化时 Redis主进程都会fork0
子进程，进行数据持久化到磁盘， Redis主进程并不会执行磁盘I/O等操什

与AOF格式的文件相比，RDB文件可以更快的重启

RDB缺点

因为RDB只能保存某个时间间限的数据，如果中途 Redis服务被稳外终止了，则会丢
间内的 Redis数据、

RDB需要经常fok0才能使用子进程将具持久化在磁盘上。如果数据集很大，fork（）可能很耗
时，并且如果数据集很大且CPU性能不佳，则可能导致 Redis停止为客户端服务几毫秒至
秒钟

AOF优点

AOF持久化保存的数据更加完整，AOF提供了三种保存策路：毎次操作保存、毎秒钟保存一
次、跟随系统的持久化氣略保存。其中每秒保存一次，从数据的安全性和性能两方面考虑是
个不错的选择，也是AOF财认的策路，即使发生了意外情况，最多只会丢失1s钟的数据

AOF采用的是命令追加的写入方式，所以不会出现文件损坏的问题，即使由于某些意外原因
导致了最后操作的持久化数据写入了一半，也可以通过 redis-check-aof工具轻松的修复

AOF持久化文件，非常容易理解和解析，它是把所有 Redis键值操作命令，以文件的方式存入
了磁盘。即使不小心使用`flushall`命令删除了所有键值信息，只些使用AOF文件，删除最
后的`flushall`命令，重启 Redis即可恢复之前误的数据

AOF缺点

对于相同的数据集来说，AOF文件大于RDB文件

在 Redis负载比较高的情况下，RDB比AOF性能更好

RDB使用快照的形式来持久化整个 Redis数据，而AOF只是将每次执行的命令追加到AOF文
件中，因此从理论上说，RDB比AOF更健社

混合持久化优点

混合持久化结合了RDB和AOF持久化的优点，开头为RDB的格式，使得 Redis可以更快的启
动，同时结合AOF的优点，有减低了大数据丢失的风险

混合持久化缺点

AOF文件中添加了RDB格式的内容，使得AOF文件的可读性变得很差兼容性差，如果开启混合持久化，那么此混合持久化AOF文件，就不能用在 Redis4.0之前版本了

# 面试题

缓存雪崩

是指在短时间内，有大量的缓存同时过期，导致大量请求直接查询数据库，从而对数据库造成巨大压力，严重的情况下会导致数据库宕机。

解决方案：

加锁排队

随机过期时间

设置二级缓存

缓存穿透

查询数据库和缓存都没有数据

缓存击穿

某个热点的缓存，在某一时刻恰好失效，然后此刻有大量的并发请求，给数据库造成巨大压力

加锁排队

设置永不过期

缓存预热

先将一部分常用的查询结构放入缓存中，后面的用户可以直接在缓存中读取。

1.把需要线存的方法写在系统初始化的方法中，这样系统在启动的时候就会自动的加載数据井缓
存数据
2.把需要缓存的方法挂載到某个页面或后端接口上，手动触发援存预热
3.设置定时任务，定时自动进行缓存预热
